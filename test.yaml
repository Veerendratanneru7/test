trigger:
- main

pool:
  name: aws-agent-1

variables:
  pythonVersion: '3.9'

steps:
- checkout: self

- task: UsePythonVersion@0
  inputs:
    versionSpec: '$(pythonVersion)'
    addToPath: true

- task: PowerShell@2
  displayName: Create venv, install deps and run script
  inputs:
    targetType: inline
    errorActionPreference: stop
    script: |
      $repo = "$(Build.SourcesDirectory)"
      $main = Get-ChildItem -Path $repo -Filter main.py -Recurse | Select-Object -First 1
      if (-not $main) { Write-Error "main.py not found"; exit 1 }
      Write-Host "Running: $($main.FullName)"

      python -m venv .venv
      $py = Join-Path (Get-Location) ".venv\Scripts\python.exe"
      & $py -m pip install --upgrade pip

      $req = Join-Path $repo "requirements.txt"
      if (Test-Path $req) { & $py -m pip install -r $req }

      & $py $main.FullName

    failOnStderr: false
